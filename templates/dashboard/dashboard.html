<!-- templates/dashboard/dashboard.html -->
{% extends 'dashboard/base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}


    

    <!-- Deafault username password block -->
    {% if warning %}
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        {{ warning }} 
        <a href="/update-password"><strong>Click here to update</strong></a>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="container mt-3">
        <div class="">
            <form>
                <div class="form-group d-flex align-items-center" style="width: 30%;">
                    <select id="categorySelect" class="form-control mr-2">
                        <option value="all">Select a Namespace</option>
                        {% for ns in namespaces %}
                            <option value="{{ ns }}">{{ ns }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary ms-3">Go</button>
                </div>
            </form>
        </div>
    </div>



    <div class="cluster-card">
        <div class="cluster-sidebar">
            <p><b>Cluster Information:</b></p>
            <li>Cluster Name: {{current_cluster}}</li>
            <li>Nodes: {{node_count}}</li>
            <li>Namespace: {{namespaces_count}}</li>
            <li>Pods: {{pod_count}}</li>
        </div>
        <div class="cluster-charts">
            <div class="text-center">
                <h6>Current Usage</h6>
                <div class="chart-container-bar">
                    <canvas id="usageChart"></canvas>
                </div>
                <h6>Total CPU: {{cpu}}, Total Memory: {{memory}}</h6>
            </div>
            <div class="cluster-chart-container" >
                <canvas id="nodesChart" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                <p class="cluster-text-center">Nodes: {{node_count}}</p>
            </div>
            <div class="cluster-chart-container">
                <canvas id="podsChart" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                <p class="cluster-text-center">Pods: {{pod_count}}</p>
            </div>
        </div>
    </div>


    <div class="container my-5">
        <div class="row mb-4 dash-cards">
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">Deployments</p>
                    <p class="card-text text-dark">{{ deployments_status.Count }}</p>
                    <canvas id="deploymentChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">DaemonSet</p>
                    <p class="card-text text-dark">{{daemonset_status.Count}}</p>
                    <canvas id="daemonChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">ReplicaSets</p>
                    <p class="card-text text-dark">{{replicaset_status.Count}}</p>
                    <canvas id="replicaChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">StatefulSets</p>
                    <p class="card-text text-dark">{{statefulset_status.Count}}</p>
                    <canvas id="statefulChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">Jobs</p>
                    <p class="card-text text-dark">{{jobs_status.Count}}</p>
                    <canvas id="jobChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
            <div class="col-lg-2">
                <div class="card text-center p-4">
                    <p class="card-title bold">CronJobs</p>
                    <p class="card-text text-dark">{{cronjob_status.Count}}</p>
                    <canvas id="cronjobChart" class="dash-card-canvas" role="doughnut-graph" aria-label="health"><p>Error displaying graph</p></canvas>
                </div>
            </div>
        </div>

        <!-- Resource Usage Summary -->
        <!-- <div class="row">
          <div class="col-lg-6">
              <div class="card text-center p-4">
                  <h5 class="card-title">Cluster CPU Usage</h5>
                  <div class="progress">
                      <div class="progress-bar bg-info" role="progressbar" style="width: 65%;">65%</div>
                  </div>
              </div>
          </div>
          <div class="col-lg-6">
              <div class="card text-center p-4">
                  <h5 class="card-title">Cluster Memory Usage</h5>
                  <div class="progress">
                      <div class="progress-bar bg-success" role="progressbar" style="width: 75%;">75%</div>
                  </div>
              </div>
          </div>
        </div> -->
    </div>

    <!-- Node Status -->
    <!-- <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5>Node Status</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th>Node Name</th>
                            <th>Status</th>
                            <th>CPU Usage</th>
                            <th>Memory Usage</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Node-1</td>
                            <td><span class="status-badge bg-success rounded-pill text-white p-1">Ready</span></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 70%;">70%</div>
                                </div>
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 60%;">60%</div>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>Node-2</td>
                            <td><span class="status-badge bg-danger rounded-pill text-white p-1">NotReady</span></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-info" role="progressbar" style="width: 50%;">50%</div>
                                </div>
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" role="progressbar" style="width: 30%;">30%</div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div> -->
    <div class="container">
        <!-- Dropdown with checkboxes to select columns -->
        <div class="mb-3">
          <label for="columnSelector" class="form-label">Select Columns to Display</label>
            <div class="dropdown">
              <button class="btn btn-custom dropdown-toggle" type="button" id="columnSelector" data-bs-toggle="dropdown" aria-expanded="false">
                Select Columns
              </button>
              <ul class="dropdown-menu p-2" aria-labelledby="columnSelector">
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Namespace" id="Namespace" checked> 
                    <label class="form-check-label" for="Namespace"> Namespace</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Name" id="Name" checked> 
                    <label class="form-check-label" for="Name"> Name</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Containers" id="Containers" checked> 
                    <label class="form-check-label" for="Containers"> Containers</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Node" id="Node" checked> 
                    <label class="form-check-label" for="Node"> Node</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="IP" id="IP" checked> 
                    <label class="form-check-label" for="IP"> IP</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Restarts" id="Restarts" checked> 
                    <label class="form-check-label" for="Restarts"> Restarts</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Age" id="Age" checked> 
                    <label class="form-check-label" for="Age"> Age</label>
                </li>
                <li>
                    <input class="form-check-input column-checkbox" type="checkbox" value="Status" id="Status" checked> 
                    <label class="form-check-label" for="Status"> Status</label>
                </li>
              </ul>
            </div>
        </div>
        <table class="table table-bordered">
            <thead class="table-dark">
            <tr>
              <th id="colNamespace">NAMESPACE</th>
              <th id="colName">NAME</th>
              <th id="colContainers">CONTAINERS</th>
              <th id="colNode">NODE</th>
              <th id="colIP">IP</th>
              <th id="colRestarts">RESTARTS</th>
              <th id="colAge">AGE</th>
              <th id="colStatus">STATUS</th>
            </tr>
            </thead>
            <tbody>
            <tr>
              <td>default</td>
              <td>app1</td>
              <td>2/2</td>
              <td>node1</td>
              <td>192.168.1.1</td>
              <td>2</td>
              <td>12h</td>
              <td>Running</td>
            </tr>
            </tbody>
        </table>
    </div>

  <script>
    
    // Function to toggle column visibility based on checkbox selections
    document.querySelectorAll(".form-check-input").forEach(function (checkbox) {
      checkbox.addEventListener("change", function () {
        toggleColumns();
        saveSelection();
      });
    });
  
    // Function to save the column selection in localStorage
    function saveSelection() {
      const selectedColumns = [];
      document.querySelectorAll(".form-check-input").forEach(function (checkbox) {
        if (checkbox.checked) {
          selectedColumns.push(checkbox.value);
        }
      });
      localStorage.setItem("selectedColumns", JSON.stringify(selectedColumns));
    }
  
    // Function to load the column selection from localStorage
    function loadSelection() {
    const savedSelection = JSON.parse(localStorage.getItem("selectedColumns"));

    if (savedSelection && savedSelection.length > 0) {
        document.querySelectorAll(".form-check-input").forEach(function (checkbox) {
        checkbox.checked = savedSelection.includes(checkbox.value);
        });
    } else {
        // Ensure all checkboxes remain checked by default
        document.querySelectorAll(".form-check-input").forEach(function (checkbox) {
        checkbox.checked = true;
        });
        saveSelection();  // Save the default checked state
    }
    }
  
    // Function to show or hide columns based on selected checkboxes
    function toggleColumns() {
      const checkboxes = document.querySelectorAll(".form-check-input");
      
      checkboxes.forEach(function (checkbox) {
        const columnName = checkbox.value;
        const column = document.getElementById("col" + columnName);
        const columnCells = document.querySelectorAll("td:nth-child(" + (getColumnIndex(columnName)) + ")");
  
        if (checkbox.checked) {
          column.style.display = 'table-cell';
          columnCells.forEach(cell => {
            cell.style.display = 'table-cell';
          });
        } else {
          column.style.display = 'none';
          columnCells.forEach(cell => {
            cell.style.display = 'none';
          });
        }
      });
    }
  
    // Function to get the column index by column name
    function getColumnIndex(columnName) {
      const columns = ["Namespace", "Name", "Containers", "Node", "IP", "Restarts", "Age", "Status"];
      return columns.indexOf(columnName) + 1;
    }
  
    // Initialize the table with the default visibility and selected columns
    window.onload = function () {
      loadSelection();  // Load saved column selection
      toggleColumns();  // Apply column visibility based on selection
    };

    // CPU and Memory usage graph
    var usageChart = document.getElementById('usageChart').getContext('2d');
        var myChart0 = new Chart(usageChart, {
            type: 'bar',
            data: {
                labels: ['CPU Usage', 'Memory Usage'],
                datasets: [{
                    label: 'Usage (in %)',
                    backgroundColor: ['rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)'],
                    data: [35, 66],
                    barThickness: 50
                }]
            },
            options: {
                responsive: true,
                // cutout: '80%',
                hoverOffset: 3, // hover effect
                maintainAspectRatio: false,
                scales: {
                y: { beginAtZero: true, max: 100 }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

    // node graph
    var nodesGraph = document.getElementById('nodesChart').getContext('2d');
        var myChart1 = new Chart(nodesGraph, {
            type: 'doughnut',
            data: {
                labels: ['Ready','Not Ready'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(50, 108, 229)',
                      'rgb(255, 204, 0)',
                    ],
                    borderWidth: 1,
                    data: ["{{ready_nodes}}","{{not_ready_nodes}}"]
                }]
            },
            options: {
                responsive: false,
                cutout: '80%',
                hoverOffset: 5, // hover effect
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // pod graph
    var podsGraph = document.getElementById('podsChart').getContext('2d');
        var myChart2 = new Chart(podsGraph, {
            type: 'doughnut',
            data: {
                labels: ['Pending','Running','Failed','Succeeded'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(255, 204, 0)',
                      'rgb(40, 167, 69)',
                      'rgb(220, 53, 69)',
                      'rgb(169,169,169)'
                    ],
                    borderWidth: 1,
                    data: ["{{status_count.Pending}}","{{status_count.Running}}","{{status_count.Failed}}", "{{status_count.Succeeded}}"]
                }]
            },
            options: {
                responsive: true,
                cutout: '80%',
                hoverOffset: 5, // hover effect
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

    // deployment graph
    var deploymentGraph = document.getElementById('deploymentChart').getContext('2d');
        var myChart3 = new Chart(deploymentGraph, {
            type: 'doughnut',
            data: {
                labels: ['Running','Pending'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                        'rgb(40, 167, 69)',
                        'rgb(255, 204, 0)'
                    ],
                    borderWidth: 1,
                    data: ["{{deployments_status.Running}}", "{{deployments_status.Pending}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // daemonset graph
    var daemonsetGraph = document.getElementById('daemonChart').getContext('2d');
        var myChart4 = new Chart(daemonsetGraph, {
            type: 'doughnut',
            data: {
                labels: ['Running','Pending'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                        'rgb(40, 167, 69)',
                        'rgb(255, 204, 0)'
                    ],
                    borderWidth: 1,
                    data: ["{{daemonset_status.Running}}","{{daemonset_status.Pending}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // replicaset graph
    var replicasetGraph = document.getElementById('replicaChart').getContext('2d');
        var myChart5 = new Chart(replicasetGraph, {
            type: 'doughnut',
            data: {
                labels: ['Running','Pending'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(40, 167, 69)',
                      'rgb(255, 204, 0)'
                    ],
                    borderWidth: 1,
                    data: ["{{replicaset_status.Running}}","{{replicaset_status.Pending}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // statefulset graph
    var statefulsetGraph = document.getElementById('statefulChart').getContext('2d');
        var myChart6 = new Chart(statefulsetGraph, {
            type: 'doughnut',
            data: {
                labels: ['Running','Pending'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(40, 167, 69)',
                      'rgb(255, 204, 0)'
                    ],
                    borderWidth: 1,
                    data: ["{{statefulset_status.Running}}","{{statefulset_status.Pending}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // job graph
    var jobGraph = document.getElementById('jobChart').getContext('2d');
        var myChart7 = new Chart(jobGraph, {
            type: 'doughnut',
            data: {
                labels: ['Completed','Failed','In-progress'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(169,169,169)',
                      'rgb(220, 53, 69)',
                      'rgb(255, 204, 0)'
                    ],
                    borderWidth: 1,
                    data: ["{{jobs_status.Completed}}", "{{jobs_status.Failed}}", "{{jobs_status.Running}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    // cronjob graph
    var cronjobGraph = document.getElementById('cronjobChart').getContext('2d');
        var myChart8 = new Chart(cronjobGraph, {
            type: 'doughnut',
            data: {
                labels: ['In-progress','Completed'],
                datasets: [{
                    label: 'Count',
                    backgroundColor: [
                      'rgb(255, 204, 0)',
                      'rgb(169,169,169)'
                    ],
                    borderWidth: 1,
                    data: ["{{cronjob_status.Running}}","{{cronjob_status.Completed}}"]
                }]
            },
            options: {
                responsive: false,
                hoverOffset: 3, // hover effect
                cutout: '80%',
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
  </script>
{% endblock %}